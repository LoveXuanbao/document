# 一、升级说明

kubenetes 集群小版本升级基本上只是需要更新二进制文件即可；如果大版本升级需要注意 kubelet 参数的变化，以及其他组件升级之后的变化。

# 二、准备工作

下载1.25.10安装包，并上传至服务器/tmp目录下

```bash
https://dl.k8s.io/v1.25.10/kubernetes-server-linux-amd64.tar.gz
```

解压 1.25.10 安装包

```bash
cd /tmp
tar -zxf kubernetes-server-linux-amd64.tar.gz
```



# 三、升级Master

## 3.1、创建备份文件存放目录

```bash
mkdir /backup
```

## 3.2、备份master节点二进制文件

```bash
cd /usr/local/bin/
cp kube-apiserver kube-controller-manager kube-scheduler kubectl /backup/
```

## 3.3、停止Master节点服务

```bash
systemctl stop kube-apiserver
systemctl stop kube-controller-manager 
systemctl stop kube-scheduler
```

## 3.4、替换Master的二进制文件

```bash
cp /tmp/kubernetes/server/bin/kube-apiserver /usr/local/bin/     # 提示是否替换，输入 y 即可
cp /tmp/kubernetes/server/bin/kube-controller-manager  /usr/local/bin/    # 提示是否替换，输入 y 即可
cp /tmp/kubernetes/server/bin/kube-scheduler /usr/local/bin/     # 提示是否替换，输入 y 即可
cp /tmp/kubernetes/server/bin/kubectl/usr/local/bin/     # 提示是否替换，输入 y 即可
```

## 3.5、启动Mster服务

```bash
systemctl start kube-apiserver
systemctl start kube-controller-manager 
systemctl start kube-scheduler
```

## 3.6、查看Master服务版本

```bash
[root@k8s-master-1 kubernetes]# kube-apiserver --version
Kubernetes v1.25.10
[root@k8s-master-1 kubernetes]# kube-controller-manager --version
Kubernetes v1.25.10
[root@k8s-master-1 kubernetes]# kube-scheduler --version
Kubernetes v1.25.10
[root@k8s-master-1 kubernetes]# kubectl version
WARNING: This version information is deprecated and will be replaced with the output from kubectl version --short.  Use --output=yaml|json to get the full version.
Client Version: version.Info{Major:"1", Minor:"25", GitVersion:"v1.25.10", GitCommit:"e770bdbb87cccdc2daa790ecd69f40cf4df3cc9d", GitTreeState:"clean", BuildDate:"2023-05-17T14:12:20Z", GoVersion:"go1.19.9", Compiler:"gc", Platform:"linux/amd64"}
Kustomize Version: v4.5.7
Server Version: version.Info{Major:"1", Minor:"25", GitVersion:"v1.25.10", GitCommit:"e770bdbb87cccdc2daa790ecd69f40cf4df3cc9d", GitTreeState:"clean", BuildDate:"2023-05-17T14:06:35Z", GoVersion:"go1.19.9", Compiler:"gc", Platform:"linux/amd64"}
```



# 四、升级Node

## 4.1、设置 node 节点不可调度

```bash
kubectl cordon 10.202.43.46
```

- 查看设置是否成功

```bash
kubectl get nodes 
NAME            STATUS                     ROLES    AGE   VERSION
k8s-master-1    Ready,SchedulingDisabled   <none>   19d   v1.19.0
k8s-master-2    Ready                      <none>   19d   v1.19.0
k8s-master-3    Ready                      <none>   19d   v1.19.0
k8s-node-1      Ready                      <none>   19d   v1.19.0
k8s-node-2      Ready                      <none>   19d   v1.19.0
```

## 4.2、驱逐 node 节点上的Pod

```bash
kubectl drain k8s-master-1 --delete-local-data --ignore-daemonsets --force

# 返回结果如下表示驱逐成功
Flag --delete-local-data has been deprecated, This option is deprecated and will be deleted. Use --delete-emptydir-data.
node/k8s-master-1 already cordoned
Warning: ignoring DaemonSet-managed Pods: kube-system/calico-node-c9rzm
evicting pod kube-system/coredns-69d4d7f76c-rm4m6
evicting pod argo/argocd-redis-5d947bcc8c-mcgft
pod/argocd-redis-5d947bcc8c-mcgft evicted
pod/coredns-69d4d7f76c-rm4m6 evicted
node/k8s-master-1 drained
```

## 4.3、备份 node 服务二进制文件

```bash
cp kube-proxy kubelet /backup/
```

## 4.4、停止 Node 服务

```bash
systemctl stop kube-proxy
systemctl stop kubelet
```



```bash
kubectl uncordon k8s-node01
```

