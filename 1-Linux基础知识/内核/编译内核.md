## **一、 编译内核**

**编译安装内核准备：**

1. 准备好开发环境
2. 获取目标主机上硬件设备的相关信息
3. 获取目标主机系统功能的相关信息，例如:需要启用相应的文件系统
4. 获取内核源代码包，[www.kernel.org](http://www.kernel.org)

### **1.1 编译准备**

#### **1.1.1 目标主机硬件设备相关信息**

**CPU：**

```bash
[root@centos8 ~]# lscpu 
Architecture:        x86_64
```

**PCI设备：lspci -v，-w**

```bash
[root@centos8 ~]# lspci
00:00.0 Host bridge: Intel Corporation 440FX - 82441FX PMC [Natoma] (rev 02)
00:01.0 ISA bridge: Intel Corporation 82371SB PIIX3 ISA [Natoma/Triton II]
00:01.1 IDE interface: Intel Corporation 82371SB PIIX3 IDE [Natoma/Triton II]
00:01.2 USB controller: Intel Corporation 82371SB PIIX3 USB [Natoma/Triton II] (rev 01)
00:01.3 Bridge: Intel Corporation 82371AB/EB/MB PIIX4 ACPI (rev 03)
00:02.0 VGA compatible controller: Cirrus Logic GD 5446
00:03.0 Communication controller: Red Hat, Inc. Virtio console
00:04.0 SCSI storage controller: Red Hat, Inc. Virtio block device
00:05.0 Ethernet controller: Red Hat, Inc. Virtio network device
00:06.0 Unclassified device [00ff]: Red Hat, Inc. Virtio memory balloon
00:1f.0 PCI bridge: Red Hat, Inc. QEMU PCI-PCI bridge
```

**USB设备：lsusb**

```bash
[root@centos8 ~]# lsusb
Bus 001 Device 002: ID 0627:0001 Adomax Technology Co., Ltd 
Bus 001 Device 001: ID 1d6b:0001 Linux Foundation 1.1 root hub
```

**lsblk快设备**

```bash
全部硬件设备信息：
```

#### **1.1.2 开发环境相关包**

```bash
[root@centos8 ~]# yum install make ncurses-devel flex bison openssl-devel elfutils-libelf-devel
```

#### **1.1.3 内核编译安装实现**

- **下载源码文件**
- **准备文本配置文件/boot/config-`uname -r`**
- **make menuconfig:配置内核选项，相当于./configure**

```bash
[ ]:N
[M]:M
[*]:Y
```

- make [-j #] 或者用以下两步实现：

- - make -j # bzImage
  - make -j # modules

- 安装模块：make modules_install

- 安装内核相关文件：make install

- - 安装bzImage为 /boot/vmlinuz-VERSION-RELEASE
  - 生成initramfs文件编辑
  - grub的配置文件

#### **1.1.4 编译安装内核实战案例**

```bash
[root@centos8 ~]# yum -y install gcc make ncurses-devel flex bison openssl-devel elfutils-libelf-devel
[root@centos8 ~]# tar xf linux-5.10.5.tar.xz -C /mnt/
[root@centos8 ~]# cd /mnt/linux-5.10.5/
[root@centos8 linux-5.10.5]# cp /boot/config-`uname -r` ./.config
[root@centos8 linux-5.10.5]# vim .config
# CONFIG_MODULE_SIG is not set 
CONFIG_SYSTEM_TRUSTED_KEYS=""
# CONFIG_DEBUG_INFO_BTF=y     #linux-5.8.5需要注释此行
[root@centos8 linux-5.10.5]# make menuconfig
[root@centos8 linux-5.10.5]# make -j 32 #数值根据自己cpu个数选择
#或者两步实现：make -j 2 bzImage ; make -j 2 modules
[root@centos8 linux-5.10.5]# pwd
/mnt/linux-5.10.5
[root@centos8 linux-5.10.5]# du -sh
16G	.
[root@centos8 linux-5.10.5]# make modules_install
[root@centos8 linux-5.10.5]# ls /lib/modules
4.18.0-187.el8.x86_64  4.18.0-193.28.1.el8_2.x86_64  4.18.0-193.el8.x86_64  5.10.5
[root@centos8 linux-5.10.5]# du -sh /lib/modules/5.10.5/
4.2G	/lib/modules/5.10.5/
[root@centos8 linux-5.10.5]# make install
sh ./arch/x86/boot/install.sh 5.10.5 arch/x86/boot/bzImage \
	System.map "/boot"
[root@centos8 linux-5.10.5]# ls /boot/
config-4.18.0-193.28.1.el8_2.x86_64
config-4.18.0-193.el8.x86_64
efi
grub2
initramfs-0-rescue-20201120143309750601020764519652.img
initramfs-4.18.0-193.28.1.el8_2.x86_64.img
initramfs-4.18.0-193.28.1.el8_2.x86_64kdump.img
initramfs-4.18.0-193.el8.x86_64.img
initramfs-4.18.0-193.el8.x86_64kdump.img
initramfs-5.10.5.img
initramfs-.img
loader
System.map
System.map-4.18.0-193.28.1.el8_2.x86_64
System.map-4.18.0-193.el8.x86_64
System.map-5.10.5
vmlinuz
vmlinuz-0-rescue-20201120143309750601020764519652
vmlinuz-4.18.0-193.28.1.el8_2.x86_64
vmlinuz-4.18.0-193.el8.x86_64
vmlinuz-5.10.5
[root@centos8 linux-5.10.5]# chmod +x /boot/vmlinuz-5.10.5
[root@centos8 linux-5.10.5]# ls /boot/loader/entries/
20201120143309750601020764519652-0-rescue.conf
20201120143309750601020764519652-4.18.0-193.28.1.el8_2.x86_64.conf
20201120143309750601020764519652-4.18.0-193.el8.x86_64.conf
20201120143309750601020764519652-5.10.5.conf
[root@centos8 linux-5.10.5]# cat /boot/loader/entries/20201120143309750601020764519652-5.10.5.conf 
title CentOS Linux (5.10.5) 8 (Core)
version 5.10.5
linux /boot/vmlinuz-5.10.5
initrd /boot/initramfs-5.10.5.img $tuned_initrd
options $kernelopts $tuned_params
id centos-20210109082754-5.10.5
grub_users $grub_users
grub_arg --unrestricted
grub_class kernel
[root@centos8 ~]# uname -r
5.10.5
```

#### 1.1.5 内核编译说明

**配置内核选项：**

- **支持“更新”模式进行配置：make help**

```bash
make config：基于命令行以遍历的方式配置内核中可配置的每个选项
make menuconfig：基于curses的文本窗口界面
make gconfig：基于GTK (GNOME）环境窗口界面
make xconfig：基于QT(KDE)环境的窗口界面
```

- **支持“全新配置”模式进行配置**

```bash
make defconfig：基于内核为目标平台提供的“默认”配置进行配置
make allyesconfig: 所有选项均回答为“yes“
make allnoconfig: 所有选项均回答为“no“
```

  **编译内核：**

- **全编译**

```bash
make [-j #]
```

- **编译内核的一部分功能：**

只编译某子目录中的相关代码

```bash
cd /usr/src/linux; make dir/
```

只编译一个特定的模块

```bash
cd /usr/src/linux; make dir/file.ko
```

**范例：只为e1000编译驱动：**

```bash
make drivers/net/ethernet/intel/e1000/e1000.ko
```

**交叉编译内核**

编译的目标平台与当前平台不相同

```bash
make    ARCH=arch_name
```

要获取特定目标平台的使用帮助

```bash
make    ARCH=arch_name help
```

示例：

```bash
make  ARCH=arm help
```

**从新编译需要事先清理操作**

```bash
make clean：清理大多数编译生成的文件，但会保留.config文件等
make mrproper: 清理所有编译生成的文件、config及某些备份文件
make distclean：包含 make mrproper,并清理patches以及编辑器备份文件
```

#### 1.1.6 卸载内核

- 删除/usr/src/linux/目录下不需要的内核源码
- 删除/lib/modules/目录下不需要的内核库文件
- 删除/boot目录下启动的内核和内核映像文件
- 更改grub的配置文件，删除不需要的内核启动列表 grub2-mkconfig -o /boot/grub2/grub.cfg
- CentOS 8 还需要删除 /boot/loader/entries/5b85fc7444b240a992c42ce2a9f65db5-新内核版本.conf