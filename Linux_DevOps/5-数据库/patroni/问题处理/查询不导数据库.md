## 问题出现过程复现

### 环境介绍

openstack上创建了三台虚拟机

在三台服务器上部署了`patroni+etcd+postgres`组成了一个postgresql数据库高可用。

其中一台虚拟机要进行`openstack`虚拟机迁移（底层服务器迁移）

### 问题复现

要迁移的服务器进行关机，关机前后没有做检查，（该节点是否为Leader节点，集群状态是否正常，关机之后`Leader`是否正常切换）

在虚拟机迁移完成后，启动服务器，启动`patroni`，启动`etcd`，查看集群状态，发现没有找到集群`Leader`

![](https://niuzhan-1306014148.cos.ap-beijing.myqcloud.com/Typora/image-1588144273974.png)

## 排查解决过程

### 排查`patroni`

##### 先查看`patroni`状态，都认为自己不是最健康的节点

- patroni-1

  ![image-20221120184126851](https://niuzhan-1306014148.cos.ap-beijing.myqcloud.com/Typora/image-20221120184126851.png)

- patroni-2

  ![image-20221120184206442](https://niuzhan-1306014148.cos.ap-beijing.myqcloud.com/Typora/image-20221120184206442.png)

- patroni-3

  ![image-20221120184236306](https://niuzhan-1306014148.cos.ap-beijing.myqcloud.com/Typora/image-20221120184236306.png)

##### 然后在`/var/log/message`日志中发现etcd报错（patroni连接etcd的2379端口超时）

![image-20221120184303623](https://niuzhan-1306014148.cos.ap-beijing.myqcloud.com/Typora/image-20221120184303623.png)

![image-20221120184331412](https://niuzhan-1306014148.cos.ap-beijing.myqcloud.com/Typora/image-20221120184331412.png)

##### 继续排查`etcd`，发现`etcd`集群不稳定

![](https://niuzhan-1306014148.cos.ap-beijing.myqcloud.com/Typora/1650609002.jpg)

然后在一篇[patroni+etcd+postgresql文章](https://www.linode.com/docs/databases/postgresql/create-a-highly-available-postgresql-cluster-using-patroni-and-haproxy/#install-etcd)看到下面一段话

![](https://niuzhan-1306014148.cos.ap-beijing.myqcloud.com/Typora/1650609047(1).jpg)

`etcd`是用来存储`postgres`集群状态的，那是不是问题就出在了`etcd`不稳定，导致了`patroni`不知道哪个节点是`Leader`节点？

### 排查`etcd`

在查看`etcd`的状态中，发现集群中每台机器都是和另外两台的`etcd`服务，不能正常通信。

![](https://niuzhan-1306014148.cos.ap-beijing.myqcloud.com/Typora/1650609098.jpg)

借用[k8s集群中遇到etcd集群故障的排查思路](https://www.cnblogs.com/zc1741845455/p/11137664.html)中的方法，思考当前环境的集群是否是成员信息紊乱导致的，备份了三台主机上的`etcd`数据目录，然后重启所有主机`etcd`服务，查看状态，集群恢复正常

![](https://niuzhan-1306014148.cos.ap-beijing.myqcloud.com/Typora/1650609126.jpg)

间隔1分钟左右查询了几次`etcd`集群，状态均为正常

![](https://niuzhan-1306014148.cos.ap-beijing.myqcloud.com/Typora/1650609163.jpg)

通过`patroni`查看`postgres`集群状态，恢复正常

![](https://niuzhan-1306014148.cos.ap-beijing.myqcloud.com/Typora/1650609186.jpg)

测试切换是否正常，停止`patroni-1`服务器上的`patroni`服务，查看`Leader`是否正常切换

![](https://niuzhan-1306014148.cos.ap-beijing.myqcloud.com/Typora/1650609218.jpg)

启动`patroni-1`服务器上的`patroni`服务，查看是否添加到集群中

![](https://niuzhan-1306014148.cos.ap-beijing.myqcloud.com/Typora/1650609243.jpg)

集群恢复正常