# 一、DRBD介绍

- DRBD(Dustrubyted ReplicatedBlock Device)是一种基于软件的，无共享，分布式块设备复制的存储解决方案，在服务器之间对块设备(磁盘，分区，逻辑卷等)进行镜像。也就是说当某一个应用程序完成写操作后，它提交的数据不仅仅会保存在本地块设备上，DRBD也会将这份数据复制一份，通过网络传输到另一个节点的块设备上。这样，两个节点上的块设备上的数据将会保持一致，这就是镜像功能。
- DRBD是有内核模块和相关脚本而构成，用以构建高可用性的集群，其实现方式是通过网络来镜像整个设备。它允许用户在远程机器上建立一个本地块设备的实时镜像，与心跳连接结合使用，可以把它看作是一种网络RAID，它允许用户在远程机器上建立一个本地块设备的实时镜像。
- DRBD工作在内核当中，类似与一种驱动模块。DRBD工作的位置在文件系统的buffer cache和磁盘调度器之间，通过tcp/ip发给另外一台主机到对方的tcp/ip最终发送给对方的drbd，再有对方的drbd存储在本地对应磁盘上，类似于一个网络RAID-1功能。在高可用（HA）中使用DRBD功能，可以代替使用一个共享盘阵。本地（主节点）与远程主机（备节点）的数据可以保证实时同步。当本地系统出现故障时，远程主机上还会保留有一份相同的数据，可以继续使用。

# 二、DRBD工作原理

- DRBD是Linux内核的存储层中的一个分布式存储系统，可以使用DRBD在两台Linux服务器之间共享块设备，共享文件系统和数据。类似于一个网络RAID-1的功能。其工作原理的架构图如下：

![image-20230825155636708](https://niuzhan-1306014148.cos.ap-beijing.myqcloud.com/Typora/image-20230825155636708.png)

## DRBD底层设备支持

- DRBD需要构建在底层设备之上，然后构建出一个设备出来。对于用户来说，一个DRBD设别，就像是一块物理的磁盘，可以在上面创建文件系统。
- DRBD所支持的底层设备有以下这些类:
  1. 一个磁盘，或者是磁盘的某个分区；
  2. 一个soft raid设备；
  3. 一个LVM逻辑卷；
  4. 一个EVMS（Enterprise Volume Management System，企业卷管理系统）的卷；
  5. 其他任何的块设备。

## DRBD的工作原理

- DRBD是一种块设别，可以被用于高可用（HA）之中，它类似于一个网络RAID-1功能。当你将数据写入本地文件系统时，数据还将会发送到网络中的另一台主机上，以相同的形式记录在一个文件系统中。本地（主节点）于远程主机（备节点）的数据可以保证实时同步。当本地系统故障时，远程主机上还会保留有一份相同的数据，可以继续使用，在高可用（HA）中使用DRBD功能。可以代替使用一个共享盘阵，因为数据同时存在本地主机和远程主机上，切换时，远程主机只要使用它上面的那份备份数据，就可以继续进行服务了。

## DRBD的工作机制

- DRBD Primary负责接收数据，把数据写道本地磁盘并发送给另一台主机DRBD Secondary，另一个主机再将数据存到自己的磁盘中。目前，DRBD每次只允许对一个节点进行读写访问，但这对于通常的故障切换高可用集群来说已经足够用了。以后的版本将支持两个节点进行读写存取。

## DRBD协议说明

1. 数据一旦写入磁盘并发送到网络中就认为完成了写入操作；
2. 收到接收确认就认为完成了写入操作；
3. 收到写入确认就任务完成了写入操作。

## DRBD与HA的关系

- 一个DRBD系统由两个节点构成，与HA集群类似，也有主节点和备用节点之分，在带有主要设备的节点上，应用程序和操作系统可以运行和访问DRBD设备（/dev/drbd*）。
- 在主节点写入的数据通过DRBD设备存储到主节点的磁盘设备中，同时，这个数据也会自动发送到备用节点对应的DRBD设备，最终写入备用节点的磁盘设备上，在备用节点上，DRBD只是将数据从DRBD设备写入到备用节点的磁盘中。现在大部分的高可用集群都会使用共享存储，而DRBD也可以作为一个共享存储设备，使用DRBD不需要太多的硬件的投资。因为它在TCP/IP网络中运行，所以，利用DRBD作为共享存储设备，要节约很多成本。因为价格要比专用的存储网络便宜很多，其性能与稳定性方面也不错。

# 三、DRBD的特性（基本功能）

- 分布式复制块设备（DRBD技术）是一种基于软件的、无共享复制的存储解决方案，在服务器之间对块设备（磁盘，分区，逻辑卷等）进行镜像。
- DRBD镜像数据的特性：
  1. 实时性；当某个应用程序完成对数据的修改时，复制功能立即发生。
  2. 透明性；应用程序的数据存储在镜像块设备上时独立透明的，他们的数据在两个节点上都保存一份。因此，无论那一台服务器宕机，都不会影响应用程序读取数据的操作。所以说时透明的。
  3. 同步镜像和异步镜像；同步镜像表示当应用程序提交本地的写操作后，数据会同步写到两个节点上。异步镜像表示当应用程序提交写操作后，只有当本地节点上完成写操作后，另一个节点才可以完成写操作。

# 四、DRBD的用户空间管理工具

> 为了能够配置和管理DRBD的资源，DRBD提供了一些管理工具与内核模块进行通信。

- drbdadm:  高级的drbd程序管理套件工具。它从配置文件/etc/drbd.conf中获取所有的配置参数。`drbdadm`为`drbdsetup`和`drbdmeta`两个命令充当程序的前端应用，执行`drbdadm`实际就时执行`drbdsetup`和`drbdmeta`两个命令。
- drbdsetup:  可以让用户配置已经加载在内核中运行的DRBD模块，它时底层的DRBD程序管理套件工具。使用该命令时，所有的配置参数都需要直接在命令中定义，虽然命令很灵活，但是大大境地了命令的简单易用性，因此很多的用户很少使用`drbdsetup`。
- drbdmeta:  允许用户创建、转储、还原和修改drbd的元数据结构。这个命令也时用户很少用到的。

# 五、DRBD的模式

> DRBD有两种模式，一种是DRBD的主从模式，一种是DRBD的双主模式。

## DRBD的主从模式

- 这种模式下，其中一个节点作为主节点，另一个节点作为从节点。其中主节点可以执行读、写操作，从节点不可以挂载文件系统，因此也不可以执行读写。这种模式下，资源在任何时间都只能存储在主节点上。这种模式可以在任何的文件系统上（ext3、ext4、xfs等）。默认这种模式下，一旦主节点发生故障，从节点需要手动将资源进行转移，且主节点变成从节点和从节点变成主节点需要手动进行切换。不能自动进行转移，因此比较麻烦。为了解决手动将资源和节点进行转移，可以将DRBD做成高可用集群的资源代理（RA），这样一旦其中一个节点宕机，资源会自动转移到另一个节点。从而保证服务的连续性。

## DRBD的双主模式

- 这是DRBD8.0之后的新特性，在双主模式下，任何资源在任何特定的时间都存在两个主节点上。这种模式需要一个共享的集群文件系统，利用分布式的锁机制进行管理。如GFS和OCFS2。部署双主模式时，DRBD可以时负载均衡的集群，这就需要从两个并发的主节点中选取一个首选的访问数据。这种模式默认时禁用的，如果要是用的话必须在配置文件中进行声明。

# 六、DRBD的同步协议

- DRBD的复制功能就是将应用程序提交的数据一份保存在本地节点，一份复制传输保存在另一个节点上。但是DRBD需要对传输的数据进行确认以便保证另一个节点的写操作完成，就需要DRBD的同步协议，DRBD同步协议有三种：

### 协议A:  异步复制协议

- 一旦本地磁盘写入已经完成，数据包已在发送队列中，则写被认为是完成的。在一个节点发生故障时，可能发生数据丢失，因为被写入到远程节点上的数据可能仍在发送队列。尽管在故障转移节点上的数据是一致的，但没有及时更新。这通常是用于地理上分开的节点。
- 数据在本地完成写操作且数据以发送到TCP/IP协议栈的对类中，则认为写操作完成。如果本地节点的写操作完成，此时本地节点发生故障，而数据还处在TCP/IP队列中，则数据不会发送到对端节点上。因此，两个节点的数据将不会保持一致。这种协议虽然高效，但是并不能保证数据的可靠性。

### 协议B:  内存同步（半同步）复制协议

- 一旦本地磁盘写入已完成且复制数据包达到了对等节点则认为写在主节点上被认为是完成的。数据丢失可能发生在两个节点同时故障的情况下，因为在传输中的数据可能不会被提交到磁盘。
- 数据在本地完成写操作且数据已经到达对端节点则认为写操作完成。如果两个节点同时发生故障，即使数据到达对端节点，这种方式同样也会导致在对端节点和本地节点的数据不一致现象，也不具有可靠性。

### 协议C:  同步复制协议

- 只有在本地和远程节点的磁盘已经确认了写操作完成，写才被认为完成。没有任何数据丢失，所以这是一个集群节点的流行模式，应用也是最多的，但I/O吞吐量依赖于网络带宽。这种方式虽然不高效，但是最可靠。

> 以上三种协议中，一般使用协议C，但是选择C协议将影响流量，从而影响网络延迟。为了数据可靠性，在生产环境使用时必须慎重选择使用哪一种协议。

# 七、DRBD的资源

- 在DRBD中，资源是所有可复制移动存储的总成，它包括：
  1. 资源名称：资源名称是可以除了空白字符以外的任意ASCII码的字符。
  2. DRBD设备：DRBD的虚拟块设备。在双方节点上，DRBD设备的文件命名方式一般为/dev/drbdN，其主设备号147，N是次设备号。
  3. 磁盘配置：DRBD内部应用需要本地数据副本，元数据。在双方节点上，为各自提供的存储设备。
  4. 网络配置：双方数据同步时所使用的网络属性。