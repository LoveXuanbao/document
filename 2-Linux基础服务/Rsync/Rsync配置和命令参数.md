# 一、rsyncd.conf配置文件

## 1.1、全局参数

/etc/rsyncd.conf文件中在[moudle]之前的参数都时全局参数，也可以在全局参数下定义部分模块参数，这时该参数的值就时所有模块的默认值

```ini
port:  指定后台程序使用的端口号，默认是873
log file:  指定rsync的日志文件，而不把日志发送给syslog
pid file:  指定rsync的pid文件，默认为/var/run/rsyncd.pid
motd file:  用来指定一个消息文件，当客户端连接服务器时，将该文件内容显示给客户端，默认是没有该文件
```

## 1.2、模块参数

主要定义服务器哪个目录需要被同步，其格式必须为**[moudle]**形式，这个名字是在rsync客户端看到的名字，而服务器真正同步的数据是通过path来指定的，我们可以通过根据自己的需求，来指定多个模块，模块中可以定义的参数有：

```ini
comment:  给模块指定一个描述，该描述联通模块名在客户端连接得到模块列表时显示给客户端，默认没有
path:  指定该模块的同步的目录树路径，该参数必须指定
use chroot:  如果"use chroot"指定为true，那么rsync在传输文件以前，首先chroot到path参数所指定的目录下。这样做的原因是实现额外的安全防护，但是缺点是需要root权限，并且不能备份指向外部的符号连接所指向的目录文件，默认情况下chroot的值为true
uid:  当该模块传输文件时守护进程应该具有的uid，配合gid选项使用可以确定哪些可以访问怎么样的文件权限，默认值是nobody
gid:  指定该模块传输文件时守护进程应该具有的gid，默认值是nobody
max connections:  指定该模块的最大并发连接数量以保护服务器，超过限制的连接请求被告知随后再试；默认值是0，也就是没有限制
list:  该选项设定当客户请求可以使用的模块列表时，该模块是否应该被列出。如果该选项设置为false，可以创建隐藏的模块，默认值是true
read only:  该选项设定是否允许客户端上载文件，如果为true，那么所有的上载请求都会失败，如果为false，并且服务器目录读写权限允许，那么上载是允许的，默认值是true
exclude:  用来指定多个空格隔开的多个文件和目录（相对路径），并将其添加到exclude列表中，这等同于在客户端的命令中使用-exclude来指定模式，一个模块只能指定一个exclude选项，但是需要注意的一点是该选项有一定的安全性问题，客户端很有可能绕过exclude列表，如果希望保持特定的文件不能被访问，那就最好结合uid/gid一起使用
exclude from:  指定一个包含exclude模式的定义的文件名，服务器从该文件中读取exclude列表定义
include:  用来指定不排除符合要求的文件或目录，这等同于在客户端命令使用-include来指定模式，结合include和exclude可以定义复杂的exclude/include规则
include from:  指定一个包含include模式的定义的文件名，服务器从该文件中读取include列表定义
auth users:  该选项指定由空格或逗号分隔的用户列表，只有这些用户才允许连接该模块，这里的用户和系统用户没有任何关系，如果“auth users”被设置，那么客户端发出对该模块的连接请求以后会被rsync请求challenged进行验证身份，这里使用的challenge/response认证协议，用户名和密码以明文方式存放在“secret file”选项指定的文件中，默认情况下无需密码就可以连接模块，也就是匿名模式
secrets file:  该选项指定了一个包含定义用户名:密码对的文件，只有在“auth users”被定义的时候，该文件才有作用，文件每行包含一个“username:passwd”对，一般来说密码最好不要超过8个字符，没有默认的secures file文件名，需要指定一个（例如：/etc/rsyncd.passwd）。注意：该文件的权限一定要是600，否则客户端不能连接服务器
stick modes:  该选项指定是否检测密码文件的权限，如果该选项值为true，那么密码文件只能被rsync服务器运行身份的用户访问，其他任何用户不能访问该文件，默认值为true
hosts allow:  该选项指定哪些IP的客户端允许连接该模块。客户端模式可以定义是以下形式，单个IP地址例如：192.168.0.1，整个网段例如：192.168.0.0/24，也可以是192.168.0.0/255.255.255.0。多个IP或网段需要用空格隔开，“*” 则表示所有，默认是允许所有主机连接
hosts deny:  指定不允许连接rsync服务器的机器，可以使用hosts allow的定义方式来定义，默认是没有hosts deny配置
ignore errors:  指定rsyncd在判断是否运行传输时的删除操作时忽略server上的I/O错误，一般来说rsync在出现I/O错误时将提跳过 -delete 操作，以防止因为暂时的资源不足或其他I/O错误导致的严重问题
ignore nonreadable:  指定rsync服务器完全忽略哪些用户没有访问权限的文件，这对于在需要备份的目录中有些文件不应该被备份者得到的情况下是有意义的。
lock file:  指定支持max connections参数的锁文件，默认值是/var/run/rsyncd.lock
transfer logging:  使rsync服务器使用ftp格式的文件来记录下载和上载操作在自己单独的日志中
log format:  日志格式
timeout:  通过该选项可以覆盖客户端指定的IP超时时间，通过该选项可以确保rsync服务器不会永远等待一个崩溃的客户端，超时单位是秒，0表示没有超时定义，也是默认值，对于匿名rsync服务器来说，一般理想的数字是600
refuse options:  通过该选项可以定义一些不允许客户端对该模块使用的命令参数列表，这里必须使用命令全名，不能是简称。但发生拒绝某个命令的情况时服务器将报告错误信息然后退出。如果要防止使用压缩，应该是：“dont compress = *”
dont compress:  用来指定哪些不进行压缩处理在传输的文件，默认值是*.gz/*.tgz/*.zip/*.z/*.rpm/*.deb/*.iso/*.bz2/*.tbz
```

## 1.3、日志格式

**log format**，通过该选项用户在使用transfer logging时可以自定义日志文件的字段，其格式时一个包含格式定义符的字符串，可以使用的格式定义符如下：

| 定义符 | 说明                                   |
| ------ | -------------------------------------- |
| %h     | 远程主机名                             |
| %a     | 远程IP地址                             |
| %l     | 文件长度字数符                         |
| %p     | 该次rsync会话的进程id                  |
| %o     | 操作类型：“send”或“recv”               |
| %f     | 文件名                                 |
|        | 模块路径                               |
| %m     | 模块名                                 |
| %t     | 当前时间                               |
| %u     | 认证的用户名（匿名时时null）           |
| %b     | 实际传输的字节数                       |
| %c     | 当发送文件时，该字段记录该文件的校验码 |

默认log格式为：**%o %h [%a] %m (%u) %f %l**,一般来说，在每行的头上会添加“%t [%p]”。在源代码中同时发布有一个叫rsyncstats的perl脚本程序来统计这种格式的日志文件。



# 二、命令参数

| 选项 | 长选项               | 说明                                                         |
| ---- | -------------------- | ------------------------------------------------------------ |
| -v   | --verbose            | 详细输出模式                                                 |
| -q   | --quite              | 精简输出模式                                                 |
| -c   | --checksum           | 打开校验开关，强制对文件传输进行校验                         |
| -a   | --archive            | 归档模式，表示以递归方式传输文件，并保持所有文件属性，等于 -rlptgpD |
| -r   | --recursive          | 对子目录以递归模式处理                                       |
| -R   | --relative           | 使用相对路径信息                                             |
| -b   | --backup             | 创建备份，也就是对于目的已经存在由同样的文件名时，将老的文件重新命名为~filename，可以使用--suffix选项来指定不同的备份文件前缀 |
|      | --backup-dir         | 将备份文件存放在指定的目录下                                 |
|      | --suffix=xx          | 定义备份文件前缀                                             |
| -u   | --update             | 仅仅进行更新，也就是跳过所有已经存在于DST，并且文件时间晚于要备份的文件，（不覆盖更新的文件） |
| -l   | --links              | 保留软连接                                                   |
| -L   | --copy-links         | 像对待常规文件一样处理软连接                                 |
|      | --copy-unsafe-links  | 仅仅拷贝指向SRC路径目录树以外的连接                          |
|      | --safe-links         | 忽略指向SRC路径目录树以外的连接                              |
| -H   | --hard-links         | 保留硬链接                                                   |
| -p   | --perms              | 保持文件权限                                                 |
| -o   | --owner              | 保持文件属主信息                                             |
| -g   | --group              | 保持文件属组信息                                             |
| -D   | --devices            | 保持设备文件信息                                             |
| -t   | --times              | 保持文件时间信息                                             |
| -S   | --sparse             | 对稀疏文件进行特殊处理以节省DST的空间                        |
| -n   | --dry-run            | 试运行，不做任何更改                                         |
| -W   | --whole-file         | 完整复制文件，不进行增量传输                                 |
| -x   | --one-file-system    | 不要跨越文件系统边界                                         |
| -B   | --block-size=SIZE    | 校验算法使用的块大小，默认是700字节                          |
| -e   | --rsh=COMMAND        | 指定使用rsh、ssh方式进行数据同步                             |
|      | --rsync-path=PROGRAM | 指定远程服务器上的rsync命令所在的路径                        |
| -C   | --cvs-exclude        | 使用和CVS一样的方法自动忽略文件，用来排除哪些不希望传输的文件 |
