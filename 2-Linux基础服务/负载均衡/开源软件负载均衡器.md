# 开源软件负载均衡器

现在常用的三大开源软件负载均衡器分别是`Nginx`、`LVS`、`Haproxy`

### LVS负载均衡的特点

1. 抗负载能力强，性能高，能达到F5硬件的60%，对内存和CPU资源消耗比较低；、
2. 工作在网络4层，通过`VRRP`协议转发（仅作分发之用），具体的流量由`Linux内核`处理，因此没有流量的产生
3. 稳定性、可靠性好，自身有完美的热备方案；（如：LVS+Keepalived）
4. 应用范围比较广，可以对所有应用做负载均衡；
5. 不支持正则处理，不能做动静分离。
6. 支持负载均衡算法：rr（轮循）、wrr（带权轮循）、lc（最小连接）、wlc（权重最小连接）
7. 配置复杂，对网络依赖比较大，稳定性很高



### Nginx负载均衡的特点

1. 工作在网络的7层上，可以针对`http`应用做一些分流的策略，比如针对域名、目录结构；
2. `Nginx`对网络的依赖比较小，理论上能ping通就能进行负载功能；
3. `Nginx`的安装和配置比较简单，测试起来比较方便；
4. 也可以承担搞的负载压力且稳定，一般能支撑超过1万次的并发；
5. 对后端服务器的健康检查，只支持通过端口来检测，不支持通过`url`来检测;
6. `Nginx`对请求的异步处理可以帮助节点服务器减轻负载；
7. `Nginx`仅能支持`http`、`https`和`Email`协议，这样就在使用范围较小；
8. 不支持`Session`的支持保持，单能通过`ip_hash`来解决，对`Big request header`的支持不是很好；
9. 支持负载均衡算法：`Round-robin`（轮循）、`Weight-round-robin`（带权轮循）、`ip_hash`（IP哈希）
10. `Nginx`还能做`web`服务器即`Cache`功能



### HAPROXY负载均衡的特点

1. 支持两种代理模式：`TCP`（四层）和`HTTP`（七层），支持虚拟主机；
2. 能够补充`Nginx`的一些缺点比如`Session`的保持，`Cookie`的引导等工作；
3. 支持`url`检测后端的服务器，出问题的检测回有很好的帮助；
4. 更多负载均衡策略比如:`Dynamic Round Robin`（动态加权轮循），`Weighted Source Hash`（加权源地址哈希），`Weighted Parameter Hash`（加权URL哈希和加权参数哈希）已经实现；
5. 单纯从效率上来讲HAProxy更会比Nginx有更出色的负载均衡速度；
6. `HAProxy`可以对`Mysql`进行负载均衡，对后端的DB节点进行检测和负载均衡;
7. 支持负载均衡算法:`Round-robin`（轮循）、`Weight-round-robin`（带权轮循）、`source`（原地址保持）、`RI`（请求URL）、`rdp-cookie`（根据cookie）;
8. 不能做Web服务器即Cache。

### 三大主流软件负载均衡器适用业务场景

1. 网站建设初期，可以选用`Nginx/Haproxy`作为反向代理负载均衡（或者流量不大都可以不选用负载均衡），因为其配置简单，性能也能满足一般的业务场景。如果考虑到负载均衡器是有单点问题，可以采用`Ngixn+keepalived/Haproxy+keepalived`避免负载均衡器自身的问题。
2. 网站并发达到一定程度之后，为了提高稳定性和转发效率，可以使用`LVS`，毕竟`LVS`比`Nginx/Haproxy`要更稳定，转发效率也更高，不过维护`LVS`对维护人员的要求也会更高，投入成本也更大。



> 需要注意的是：`Nginx`与`Haproxy`比较：Nginx支持七层、用户量最大、稳定性比较可靠，`haprox`支持四层和七层，支持更多的负载均衡算法，支持`session`保存等，具体选型看使用场景，`Haproxy`由于弥补了一些`Nginx`的缺点是其用户量也在不段的提升。

> 衡量负载均衡器好坏的几个重要因素

1. 会话率：单位时间内的处理的请求数；
2. 会话并发能力：并发处理能力；
3. 数据率：处理数据能力

经过官方测试统计，`haproxy` 单位时间处理的最大请求数为`20000`个，可以同时维护`40000-50000`个并发连接，最大数据处理能力为`10Gbps`



# 三大主流软件负载均衡器的优缺点

## Nginx

### `Nginx`的优点

1. 工作在网络的7层智上，可以针对`http`应用做一些分流的策略，比如针对域名、目录结构，它的曾泽规则比`Haproxy`更为强大和灵活，这也是它目前广泛流行的主要原因之一，`Nginx`单凭这一点可以利用的场合就远多于`LVS`了

2. `Nginx`对网络稳定性的依赖非常小，理论上能 ``ping` 通就就能进行负载功能，这个也是它的优势之一；相反 LVS 对网络稳定性依赖比较大;

3. `Nginx`安装和配置比较简单，测试起来比较方便，它基本能把错误用日志打印出来。 LVS 的配置、测试就要花比较长的时间了， LVS 对网络依赖比较大。

4. 可以承担高负载压力且稳定，在硬件不差的情况下一般能支撑几万次的并发量，负载度比 LVS 相对小些。

5. Nginx 可以通过端口检测到服务器内部的故障，比如根据服务器处理网页返回的状态码、超时等等，并且会把返回错误的请求重新提交到另一个节点，不过其中缺点就是不支持url来检测。比如：用户正在上传一个文件，而处理该上传的节点刚好在上传过程中出现故障，`Nginx`会把上传切换到另一台服务器重新处理，而`LVS`就直接断掉了，如果是上传一个很大的文件或者很重要的文件话，用户可能会因此而不满。

6. `Nginx`不仅仅是一款优秀的负载均衡器/反向代理软件，它同时也是功能强大的 Web 应用服务器。 LNMP 也是近几年非常流行的 web 架构，在高流量的环境中稳定性也很好。

7. `Nginx` 现在作为 Web 反向加速缓存越来越成熟了，速度比传统的 Squid 服务器更快，可以考虑用其作为反向代理加速器。

8. Nginx 可作为中层反向代理使用，这一层面 Nginx 基本上无对手，唯一可以对比 Nginx 的就只有 lighttpd 了，不过 lighttpd 目前还没有做到 Nginx 完全的功能，配置也不那么清晰易读，社区资料也远远没 Nginx 活跃。
   
9. Nginx 也可作为静态网页和图片服务器，这方面的性能也无对手。还有 Nginx社区非常活跃，第三方模块也很多

### `Nginx`的缺点

1. `Nginx`仅能支持`http`、`https`和`Email`协议，这样就使用范围比较小些；
2. 对后端服务器的健康检查，只支持通过端口来检测，不支持通过`url`来检测，不支持`Session`的直接保持，但能通过`ip_hash`来解决

  

## LVS

> `LVS`使用 Linux 内核集群实现一个高性能、 高可用的负载均衡服务器，它具有很好的可伸缩性（ Scalability)、可靠性（ Reliability)和可管理性（Manageability)。

### `LVS`的优点

1. 抗负载能力强、是工作在网络 4 层之上仅作分发之用， 没有流量的产生，这个特点也决定了它在负载均衡软件里的性能最强的，对内存和 cpu 资源消耗比较低。
2. 配置性比较低，这是一个缺点也是一个优点，因为没有可太多配置的东西，所以并不需要太多接触，大大减少了人为出错的几率。
3. 工作稳定，因为其本身抗负载能力很强，自身有完整的双机热备方案，如LVS+Keepalived，不过我们在项目实施中用得最多的还是` LVS/DR+Keepalived`。
4. 无流量， LVS 只分发请求，而流量并不从它本身出去，这点保证了均衡器 IO的性能不会收到大流量的影响。
5. 应用范围比较广，因为 LVS 工作在 4 层，所以它几乎可以对所有应用做负载均衡，包括 http、数据库、在线聊天室等等。



### `LVS`的缺点

1. 软件本身不支持正则表达式处理，不能做动静分离；而现在许多网站在这方面都有较强的需求，这个是 `Nginx/HAProxy+Keepalived` 的优势所在。

2. 如果是网站应用比较庞大的话， `LVS/DR+Keepalived` 实施起来就比较复杂了，特别后面有 Windows Server 的机器的话，如果实施及配置还有维护过程就比较复杂了，相对而言，`Nginx/HAProxy+Keepalived`就简单多了。



## Haproxy

### `Haproxy`的优点

1. `HAProxy`是支持虚拟主机的，可以工作在4、7层(支持多网段)
2. 免费开源，稳定性也是非常好。单Haproxy也跑得不错，稳定性可以与硬件级的F5相媲美
3. 自带强大的监控服务器状态的页面，实际环境中我们结合Nagios进行邮件或短信报警
4. `HAProxy`的优点能够补充Nginx的一些缺点，比如支持Session的保持，Cookie的引导；同时支持通过获取指定的url来检测后端服务器的状态。
5. `HAProxy`跟LVS类似，本身就只是一款负载均衡软件；单纯从效率上来讲HAProxy会比Nginx有更出色的负载均衡速度，在并发处理上也是优于Nginx的。
6. `HAProxy`支持`TCP协议`的负载均衡转发，可以对`MySQL`读进行负载均衡，对后端的`MySQL`节点进行检测和负载均衡，大家可以用`LVS+Keepalived`对`MySQL`主从做负载均衡。
7. HAProxy负载均衡策略非常多，HAProxy的负载均衡算法现在具体有如下8种
   1. `roundrobin`：表示简单的轮询，每个服务器根据权重轮流使用，在服务器的处理时间平均分配的情况下这是最流畅和公平的算法。该算法是动态的，对于实例启动慢的服务器权重会在运行中调整。最大支持4095个后端主机；
   2. `leastconn`：连接数最少的服务器优先接收连接。leastconn建议用于长会话服务，例如LDAP、SQL、TSE等，而不适合短会话协议。如HTTP.该算法是动态的，对于实例启动慢的服务器权重会在运行中调整。
   3. `static-rr`：每个服务器根据权重轮流使用，类似`roundrobin`，但它是静态的，意味着运行时修改权限是无效的。另外，它对服务器的数量没有限制。该算法一般不用；
   4. `source`：对请求源IP地址进行哈希，用可用服务器的权重总数除以哈希值，根据结果进行分配。只要服务器正常，同一个客户端IP地址总是访问同一个服务器。如果哈希的结果随可用服务器数量而变化，那么客户端会定向到不同的服务器；该算法一般用于不能插入cookie的Tcp模式。它还可以用于广域网上为拒绝使用会话cookie的客户端提供最有效的粘连；该算法默认是静态的，所以运行时修改服务器的权重是无效的，但是算法会根据“hash-type”的变化做调整。
   5. `uri`：表示根据请求的URI左端（问号之前）进行哈希，用可用服务器的权重总数除以哈希值，根据结果进行分配。只要服务器正常，同一个URI地址总是访问同一个服务器。一般用于代理缓存和反病毒代理，以最大限度的提高缓存的命中率。该算法只能用于HTTP后端；该算法一般用于后端是缓存服务器；该算法默认是静态的，所以运行时修改服务器的权重是无效的，但是算法会根据“hash-type”的变化做调整。
   6. `url_param`：在HTTP GET请求的查询串中查找<param>中指定的URL参数，基本上可以锁定使用特制的URL到特定的负载均衡器节点的要求；该算法一般用于将同一个用户的信息发送到同一个后端服务器；该算法默认是静态的，所以运行时修改服务器的权重是无效的，但是算法会根据“hash-type”的变化做调整。
   7. `hdr(name)`：在每个HTTP请求中查找HTTP头<name>，HTTP头<name>将被看作在每个HTTP请求，并针对特定的节点；如果缺少头或者头没有任何值，则用roundrobin代替；该算法默认是静态的，所以运行时修改服务器的权重是无效的，但是算法会根据“hash-type”的变化做调整。
   8. `rdp-cookie(name)`：为每个进来的TCP请求查询并哈希RDP cookie<name>；该机制用于退化的持久模式，可以使同一个用户或者同一个会话ID总是发送给同一台服务器。如果没有cookie，则使用roundrobin算法代替；该算法默认是静态的，所以运行时修改服务器的权重是无效的，但是算法会根据“hash-type”的变化做调整。



### `Haproxy`的缺点

1. 不支持POP/SMTP协议；
2. 不支持SPDY协议
3.  不支持HTTP cache功能。现在不少开源的lb项目，都或多或少具备HTTP cache功能。
4. 重载配置的功能需要重启进程，虽然也是soft restart，但没有Nginx的reaload更为平滑和友好。
5. 多进程模式支持不够好



## `Nginx`和`LVS`对比总结

1. Nginx 工作在网络的 7 层，所以它可以针对 http 应用本身来做分流策略，比如针对域名、目录结构等，相比之下 LVS 并不具备这样的功能，所以 Nginx 单凭这点可利用的场合就远多于LVS了；
   但 Nginx 有用的这些功能使其可调整度要高于 LVS，所以经常要去触碰触碰，触碰多了，人为出问题的 几率也就会大。
2. Nginx 对网络稳定性的依赖较小，理论上只要 ``ping` `得通，网页访问正常， Nginx就能连得通，这是 Nginx 的一大优势！ Nginx 同时还能区 分内外网，如果是同时拥有内外网的节点，就相当于
   单机拥有了备份线路； LVS 就比较依赖于网络环境，目前来看服务器在同一网段内并且 LVS 使用 direct 方式分流，效果较能得到保证。另外注意， LVS 需要向托管商至少申请多一个 ip 来做
   Visual IP，貌似是不能用本身的 IP 来做 VIP 的。要做好 LVS 管理员，确实得跟进学习很多有关网络通信方面的知识，就不再是一个 HTTP 那么简单了。
3. Nginx 安装和配置比较简单，测试起来也很方便，因为它基本能把错误用日志打印出来。 LVS 的安装和配置、测试就要花比较长的时间了； LVS 对网络依赖比较大，很多时候不能配置成功都是
   因为网络问题而不是配置问题，出了问题要解决也相应的会麻烦得多。
4. Nginx 也同样能承受很高负载且稳定，但负载度和稳定度差 LVS 还有几个等级：Nginx 处理所有流量所以受限于机器 IO 和配置；本身的 bug 也还是难以避免的。
5. Nginx 可以检测到服务器内部的故障，比如根据服务器处理网页返回的状态码、超时等等，并且会把返回错误的请求重新提交到另一个节点。目前 LVS 中ldirectd 也能支持针对服务器内部的情况
   来监控，但 LVS 的原理使其不能重发请求。比如用户正在上传一个文件，而处理该上传的节点刚好在上传过程中 出现故障， Nginx 会把上传切到另一台服务器重新处理，而 LVS 就直接断掉了，如果
   是上传一个很大的文件或者很重要的文件的话，用户可能会因此而恼火。
6. Nginx 对请求的异步处理可以帮助节点服务器减轻负载，假如使用 apache 直接对外服务，那么出现很多的窄带链接时 apache 服务器将会占用大 量内存而不能释放，使用多一个 Nginx 做 apache
   代理的话，这些窄带链接会被 Nginx 挡住，apache 上就不会堆积过多的请求，这样就减少了相 当多的资源占用。这点使用squid 也有相同的作用，即使 squid 本身配置为不缓存，对 apache 还是有
   很大帮助的。
7. Nginx 能支持 http、 https 和 email（ email 的功能比较少用）， LVS 所支持的应用在这点上会比 Nginx 更多。在使用上，一般最 前端所采取的策略应是 LVS，也就是 DNS 的指向应为 LVS 均衡器，
   LVS 的优点令它非常适合做这个任务。重要的ip地址，最好交由 LVS 托管，比如数据 库的 ip、 webservice 服务器的 ip等等，这些 ip 地址随着时间推移，使用面会越来越大，如果更换 ip 则故障会接踵
   而至。所以将这些重要 ip 交给 LVS 托管是最为稳妥的，这样做的唯一缺点是需要的 VIP 数量会比较多。Nginx 可作为 LVS 节点机器使用，一是可以利用 Nginx的功能，二是可以利 用 Nginx 的性能。当然
   这一层面也可以直接使用 squid，squid 的功能方面就比 Nginx 弱不少了，性能上也有所逊色于 Nginx。Nginx 也可作为中层代理使用，这一层面 Nginx 基本上无对手，唯一可以撼动 Nginx 的就只有 lighttpd
   了，不过 lighttpd 目前还没有能做到 Nginx 完全的功能，配置也不那么清晰易读。另外，中层代理的 IP 也是重要的，所以中层代理也拥有一个VIP 和 LVS 是最完美的方案了。具体的应用还得 具体分析，如果
   是比较小的网站（日 PV 小于 1000 万），用 Nginx 就完全可以了，如果机器也不少，可以用DNS 轮询， LVS 所耗费的机器还是比较多 的；大型网站或者重要的服务，机器不发愁的时候，要多多考虑利用 LVS。

>
>现在对网络负载均衡的使用是随着网站规模的提升根据不同的阶段来使用不同的技术：
>1. 第一阶段：利用 Nginx 或 HAProxy 进行单点的负载均衡，这一阶段服务器规模刚脱离开单服务器、单数据库的模式，需要一定的负载均衡，但是仍 然规模较小没有专业的维护团队来进行维护，也没有需要进行大规模的网站部署。这样利用Nginx 或 HAproxy 就是第一选择，此时这些东西上手快， 配置容易，在七层之上利用 HTTP 协议就可以。这时是第一选择。
>2. 第二阶段：随着网络服务进一步扩大，这时单点的 Nginx 已经不能满足，这时使用 LVS 或者商用 Array 就是首要选择， Nginx 此时就作为 LVS 或者 Array 的节点来使用，具体 LVS 或 Array 的是选择是根据
> 公司规模和预算来选择，Array 的应用交付功能非常强大，本人在某项目中使用过，性价比也远高于 F5，商用首选！但是一般来说这阶段相关人才跟不上业务的提升，所以购买商业负载均衡已经成为了必经之路。
>3. 第三阶段：这时网络服务已经成为主流产品，此时随着公司知名度也进一步扩展，相关人才的能力以及数量也随之提升，这时无论从开发适合自身产品的定制，以及降低成本来讲开源的 LVS，已经成为首选，这时
> LVS 会成为主流。最终形成比较理想的基本架构为： Array/LVS`— Nginx/Haproxy—Squid/Varnish— AppServer。

# 负载均衡性能对比

| 序号 | 类型                          | 支持并发  |
| ---- | ----------------------------- | --------- |
| 1    | 硬件负载均衡（F5、Netscaler） | 400W~800W |
| 2    | LVS DR模式                    | 100W~400W |
| 3    | LVS NAT模式                   | 50W~100W  |
| 4    | Nginx四层/Haproxy四层         | 10W~50W   |
| 5    | Nginx七层/Haproxy七层         | 2W~5W     |
| 6    | IIS                           | 0.5W~1W   |
| 7    | Apache(httpd)                 | 3K~5K     |
| 8    | Tomcat                        | 1K        |

