## Haproxy介绍

`haproxy`是法国人Willy Tarreau开发的一款可应对客户端`10000以上`的同时连接的高性能的`TCP和HTTP负载均衡器`。由于其丰富强大的功能在国内备受推崇，是目前主流的负载均衡器，Haproxy是一个开源的高性能的反向代理或者说是负载均衡服务软件之一，它支持`双击热备`、`虚拟主机`、`基于TCP和HTTP应用代理`等功能。其配置简单，而且拥有很好的对服务器节点的健康检查功能(相当与keepalived健康检查)，当其代理的后端服务器出现故障时，Haproxy会自动的将该故障服务器摘除，当服务器的故障恢复后Haproxy还会自动重新添加回服务器主机。

Haproxy实现了一种事件驱动、单一进程模型，此模型支持非常大的并发连接数。多进程或多线程模型受内存限制、系统调度器限制以及无处不在的锁限制，很少能处理数千并发连接。事件驱动模型因为在有更好的资源和时间管理的用户空间(User-Space)实现所有这些任务，所以没有这些问题。此模型的弊端是，在多核系统上，这些程序通常扩展性较差。这就是为什么必须对其进行优化以使每个CPU时间片(Cycle)做更多的工作。

Haproxy特别适用于哪些负载特大的web站点，这些站点通常又需要会话保持或七层处理。Haproxy运行在当前的硬件上，完全可以支持数以万计的并发连接。并且他的运行模式使得它可以很简单安全的整合进当前架构中，同时可以保护web服务器不被暴漏到网络上。

Haproxy软件引入了frontend，backend的功能，frountend(ac规则匹配)可以根据任意HTTP请求头做规则匹配，然后把请求定向到相关胡backend(server pools等待前端把请求转过来的服务器组）。通过frontend肯backend，可以很容易的实现Haproxy的7层负载均衡代理功能。

Haproxy是一种高效、可靠、免费的高可用及负载均衡解决方案，非常适合于高负载站点的七层数据请求。客户端通过haproxy代理服务器获得站点页面，而代理服务器收到客户请求后根据负载均衡的规则将请求数据转发给后端真实服务器。

同一客户端访问服务器，Haproxy保持会话的三种方案：

1. haproxy将客户端IP进行Hash计算并保存，由此确保相同IP访问被转发到同一真实服务器上；

2. Haproxy依靠真实服务器发送给客户端的cookie信息进行会话保持。

3. Haproxy保存真实服务器的session及服务器标识，实现会话保持功能。



## Haproxy 工作源里

Haproxy提供高可用性、负载均衡以及基于TCP(第四层)和HTTP(第七层)引用的代理，支持虚拟主机。它是免费、快速并且可靠的一种解决方案。Haproxy特别适用于那些负载特别大的web站点，这些站点通常又需要会话保持或七层处理。Haproxy运行在时下的硬件上，完全可以支持数以万计的并发连接，并且它的运行模式使得它可以很简单的整合你当前的架构中，同时可以保护你的web服务器不被暴露到网络上。

Haproxy实现了一种事件驱动、单一进程模型，此模型支持非常的并发连接数。多进程后多进程模型受内存限制、系统调度器限制以及无处不在的锁限制，很少能处理数千并发连接。事件驱动模型因为在有更好的资源和时间管理的用户端(User-Space)实现所有这些任务，所以没有这些问题。此模型的弊端是，在多核系统上，这些程序通常扩展性较差。这就是为什么它们必须进行优化以使每个CPU时间片(Cycle)做更多的工作。



## Haproxy 优点

1. 免费开源，稳定性也非常好。单Haproxy也跑的不错，稳定性可以与硬件级的F5相媲美；

2. 根据官方文档，Haproxy可以跑满10Gbps，这个数据作为软件级负载均衡器是相当惊人的；

3. Haproxy支持连接拒绝；因为维护一个连接的打开的开销是很低的，有时我们很需要限制攻击蠕虫(attack bots)，也就是说限制它们的连接打开从而限制它们的危害。这个已经为一个陷于小型DDOS攻击的网站开发，而且已经拯救了很多站点，这个优点也是其他负载均衡器没有的；

4. Haproxy支持全透明代理(已具备硬件防火墙的典型特点)：可以用客户端IP地址或者任何其他地址来来连接后端服务器。这个特性在Linux 2.4/2.6内核打了TCP proxy补丁后才可以使用。这个特性也使得为某特殊服务器处理部分流量同时又不修改服务器的地址成为可能；

5. Haproxy现在多用于线上的MySQL集群环境，常用它作为MySQL(读)负载均衡；

6. 自带强大的监控服务器状态页面，实际环境中我们结合Nagios进行邮件或短信报警；

7. Haproxy支持虚拟主机，许多朋友说它不支持虚拟主机是错误的，但是通过测试可知，Haproxy是支持虚拟机主机的。



## Haproxy主要工作位置

![image-20230825145035084](https://niuzhan-1306014148.cos.ap-beijing.myqcloud.com/Typora/image-20230825145035084.png)

\- Haproxy支持http反向代理

\- Haproxy支持动态程序的反向代理

\- Haproxy支持基于数据库的反向代理



## Haproxy 相关术语

> 访问控制列表（ACL）

在负载均衡中，`ACL`用于测试某些状况，并根据测试结果执行某些操作（例如选定一套服务器或者屏蔽某条请求），如下ACL实例

```shell
acl url_blog path_beg /blog
```

如果用户请求的路径以/blog开头，则匹配这条ACL。举例来说http://yourdomain.com/blog/blog-entry-1请求即符合这一条件。

> Backend

所谓backend是指一组服务器，负责接收各转发请求。Backend在HAproxy配置中的backend部分进行定义。一般来讲，backend定义主要包括：

1. 使用哪种负载均衡算法
2. 一套服务器与端口列表