## hdfs副本块丢失或损坏

- hdfs 50070首页告警

```bash
There are 3 missing blocks. The following files may be corrupted:

blk_1104889162 /user/hive/.sparkStaging/application_1710141597901_0171/hive.service.keytab
blk_1104889163 /user/hive/.sparkStaging/application_1710141597901_0171/__spark_libs__7456163767073049086.zip
blk_1104889164 /user/hive/.sparkStaging/application_1710141597901_0171/__spark_libs__7456163767073049086.zip
Please check the logs or run fsck in order to identify the missing blocks. See the Hadoop FAQ for common causes and potential solutions.
```

- 运行 `hdfs fsck /` 检查结果如下

```bash
..........................
/user/hive/.sparkStaging/application_1710141597901_0171/__spark_libs__7456163767073049086.zip: CORRUPT blockpool BP-380602978-172.31.75.72-1657706037394 block blk_1104889163

/user/hive/.sparkStaging/application_1710141597901_0171/__spark_libs__7456163767073049086.zip: CORRUPT blockpool BP-380602978-172.31.75.72-1657706037394 block blk_1104889164

/user/hive/.sparkStaging/application_1710141597901_0171/__spark_libs__7456163767073049086.zip: MISSING 2 blocks of total size 246500709 B..
/user/hive/.sparkStaging/application_1710141597901_0171/hive.service.keytab: CORRUPT blockpool BP-380602978-172.31.75.72-1657706037394 block blk_1104889162

/user/hive/.sparkStaging/application_1710141597901_0171/hive.service.keytab: MISSING 1 blocks of total size 363 B........Status: CORRUPT
 Total size:    5500166272750 B (Total open files size: 8053065626 B)
 Total dirs:    1417248
 Total files:   7633439
 Total symlinks:                0 (Files currently being written: 36)
 Total blocks (validated):      7657928 (avg. block size 718231 B) (Total open file blocks (not validated): 89)
  ********************************
  UNDER MIN REPL'D BLOCKS:      3 (3.9175087E-5 %)
  dfs.namenode.replication.min: 1
  CORRUPT FILES:        2
  MISSING BLOCKS:       3
  MISSING SIZE:         246501072 B
  CORRUPT BLOCKS:       3
  ********************************
 Minimally replicated blocks:   7657925 (99.99996 %)
 Over-replicated blocks:        0 (0.0 %)
 Under-replicated blocks:       0 (0.0 %)
 Mis-replicated blocks:         0 (0.0 %)
 Default replication factor:    3
 Average block replication:     2.999999
 Corrupt blocks:                3
 Missing replicas:              0 (0.0 %)
 Number of data-nodes:          12
 Number of racks:               1
FSCK ended at Wed Apr 17 21:49:13 CST 2024 in 401478 milliseconds


The filesystem under path '/' is CORRUPT
```

## 解决办法

### 方法一

- 手动修复，对于丢失块可以直接使用方法二进行删除

```bash
hdfs debug recoverLease -path user/hive/.sparkStaging/application_1710141597901_0171/__spark_libs__7456163767073049086.zip -retries 10
```

### 方法二

- 删除损坏的块

```bash
hdfs fsck /user/hive/.sparkStaging/application_1710141597901_0171/__spark_libs__7456163767073049086.zip -delete
hadoop fsck /user/hive/.sparkStaging/application_1710141597901_0171/hive.service.keytab -delete
```

## tips

切记：删除的是损坏的 block 文件和 meta 文件，而不是删除 hdfs 文件，当然还可以先把文件 get 下载，然后 hdfs 删除，在对应上传；

删除不要执行 `hdfs fsck / -delete`，这是删除损坏的文件，那么数据就丢失了，这种情况值适用于无所谓丢数据或者有从其他地方可以补数据到 hdfs；